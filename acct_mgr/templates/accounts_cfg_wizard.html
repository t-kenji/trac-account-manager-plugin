<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      xmlns:py="http://genshi.edgewall.org/" 
      xmlns:i18n="http://genshi.edgewall.org/i18n"
      i18n:domain="acct_mgr">
  <xi:include href="layout.html" />
  <head>
    <title>Account Manager Setup</title>
  </head>

  <body>
    <div id="content" class="wizard">
      <div id="progress">
        <!-- Progress bar -->
        <ul class="progress">
          <py:for each="idx,step in enumerate(steps)">
            <li class="${step.past and 'past' or (idx == active and 'active') or None}"
                id="${idx == len(steps) - 1 and 'last' or None}"
                style="${'width:' + str(100 / len(steps)) + '%'}">
              <span>
                <a href="${href(start_href, step=idx)}">${idx + 1}</a>
              </span>
              <a href="${href(start_href, step=idx)}"
                 title="${step.image and step.label or None}">
              <img class="icon" alt="${step.label}" py:if="step.image"
                   heigth="32" width="32"
                   src="${href.chrome('/acct_mgr/' + step.image + '.png')}" />
              <py:if test="not step.image">
                $step.label
              </py:if>
              </a>
            </li>
          </py:for>
        </ul>
      </div>

      <h1>Accounts: Configuration</h1>
      <form id="cfg_wiz" method="post">
        <div class="buttons">
          <input type="hidden" name="step" value="$active" />
          <input type="submit" name="next" py:if="active != (len(steps) - 1)"
                 value="${dgettext('acct_mgr', 'Next step')}" />
        </div>
        <py:choose test="active">

          <fieldset py:when="0">
            <legend i18n:msg="step,label">
              Step ${str(active + 1)}: ${steps[active].label}
            </legend>
          <h3>Objective for setting Common Options</h3>
          <p>
            Trac sessions are authenticated per request based on browser
            cookies.  Therefor a number of options control some critical
            browser cookie properties.
          </p>

          <h3>Authentication provider-agnostic options</h3>
          <div class="field"
               py:with="value = acctmgr_loginmodule and auth_cookie_lifetime or 
                                acctmgr_loginmodule and 2592000 or
                                auth_cookie_lifetime">
            <label i18n:msg="">
              Lifetime of the authentication cookie:
              <input class="numwidget" type="text" name="auth_cookie_lifetime"
                     title="${'trac:auth_cookie_lifetime ' +
                              pretty_precise_timedelta(None, diff=value)}"
                     value="$value" />
              seconds
              <p class="hint">
                Determines how long the browser will cache authentication
                information, and therefore, after how much inactivity a user
                will have to log in again.  Default (0&nbsp;s) makes cookie
                expire at browsing sessions end.
              </p>
            </label>
          </div>
          <div class="field">
            <label>
              <input type="checkbox" name="secure_cookies" value="true"
                     title="trac:secure_cookies"
                     checked="${secure_cookies and 'checked' or None}" />
              Restrict sending cookies to HTTPS connections.
            </label>
            <p class="hint">
              Required if this Trac instance is only accessible through HTTPS.
            </p>
          </div>
          <div class="field">
            <label>
              <input type="checkbox" name="check_auth_ip" value="true"
                     title="trac:check_auth_ip"
                     checked="${check_auth_ip and 'checked' or None}" />
              Check IP address for authentication.
            </label>
            <p class="hint">
              Potentially troublesome for users with dynamic IP adress, but
              disregarded for persistant sessions.
            </p>
          </div>
          <div class="field">
            <label>
              <input type="checkbox" name="ignore_auth_case" value="true"
                     title="trac:ignore_auth_case"
                     checked="${ignore_auth_case and 'checked' or None}" />
              Convert login names to lower case on registration and login.
            </label>
          </div>

          <h3>Authentication front-end</h3>
          <div class="field">
            <label>
              <input type="radio" name="acctmgr_loginmodule" value="0"
                     checked="${acctmgr_loginmodule and 'checked' or None}" />
              Use HTTP authentication and credentials as configured in and
              provided by your web-server.
            </label>
            <p class="hint">
              You can still manage some password stores with
              AccountManagerPlugin, if you configure them in the next section.
            </p>
            <label>
              <input type="radio" name="acctmgr_loginmodule" value="1"
                     checked="${acctmgr_loginmodule and 'checked' or None}" />
              Use a HTML login form backed by one or more password stores
              managed by AccountManagerPlugin.
            </label>
            <p class="hint">
              AccountManagerPlugin provides a form-based login page, even
              integrating links to related actions:
            </p>
            <ul>
              <li><span class="hint">Lost password/Password reset</span></li>
              <li><span class="hint">Registration for new users</span></li>
            </ul>
            <p class="hint">
              accompanied by its own, custom version of LoginModule.
            </p>
            <p class="hint">
              If you enable this feature, you'll want to review and adjust
              some Trac options related to session authentication.
              Note, that AccountManagerPlugin's LoginModule changes the
              default value for auth_cookie_lifetime to 30 days.
            </p>
          </div>

          <div py:if="acctmgr_loginmodule">
            <h3>AccountManagerPlugin authentication options</h3>
            <div class="field">
              <label>
                <input type="checkbox" name="persistent_sessions" value="true"
                       checked="${persistent_sessions and 'checked' or None}"
                       title="account-manager:persistent_sessions" />
                Allow the user to be remembered across sessions without
                needing to re-authenticate.
              </label>
              <p class="hint" i18n:msg="">This is, user checks a "Remember Me"
                <tt>checkbox</tt> in the AccountManagerPlugin login form and,
                next time he visits the site within 30 days, he'll be
                remembered and authenticated automatically.
              </p>
            </div>
            <div class="field">
              <label i18n:msg="">
                Likelihood of session cookie ID change:
                <input class="numwidget" type="text" name="cookie_refresh_pct"
                       title="account-manager:cookie_refresh_pct"
                       value="$cookie_refresh_pct" />
                % per work hour
                <p class="hint">
                  Driving a refresh process to decrease vulnerability of
                  long-lasting sessions.  Zero equals to never.
                </p>
              </label>
            </div>
            <div class="field">
              <label>
                Path for authentication cookie:
                <input class="textwidget" type="text" name="auth_cookie_path"
                       title="trac:auth_cookie_path"
                       value="$auth_cookie_path" />
                <p class="hint">
                  Set this to a common base path of several Trac instances to
                  share the cookie, providing cheap Single-Sign-On experience.
                  This enables AccountManagerPlugin's authentication data
                  distribution to Trac instances with matching cookie path.
                </p>
              </label>
            </div>
          </div>
          </fieldset>

          <fieldset py:when="1">
            <legend i18n:msg="step,label">
              Step ${str(active + 1)}: ${steps[active].label}
            </legend>
            <img class="icon" alt="Password store icon"
                 src="${href.chrome('/acct_mgr/users.png')}" />

          <h3>Objective for configuring a Password Store</h3>
          <p>
            AccountManagerPlugin manages user credentials in a modular
            back-end providing access to at least one password store.
            While store chaining works flawlessly, this advanced configuration
            scenario is not supported by the configuration wizard yet.
          </p>

          <h3>Authentication back-end</h3>
          [x] Use a password store embedded into Trac db.
          <p class="hint" i18n:msg="">
            AccountManagerPlugin's <strong>SessionStore</strong> implements
            password storage in db table 'session_attributes'.  Its the
            default choice mainly for avoiding additional dependencies like
            directory and file permissions.  While great to resolve some
            concurrent access issues too, this password store has some
            shortcomings as well.  Notably it does not support seamless
            hash type migration yet, and its no candidate for shared use
            by multiple Trac instances or even by applications beyond Trac.
          </p>
          <div>
            Details
            <ul>
              <li>account-manager:hash_method [HtDigestHashMethod__]</li>
              <!-- py:if acctmgr.HtDigestHashMethod enabled -->
              <ul>
                <li>account-manager:db_htdigest_realm [______________]</li>
              </ul>
              <!-- /py:if -->
              <!-- py:if acctmgr.HtPasswdHashMethod enabled -->
              <ul>
                <li>account-manager:db_htpasswd_hash_type [md5___________]</li>
              </ul>
              <!-- /py:if -->
            </ul>
          </div>

          [_] Use a writable file-based password store.
          <p class="hint">
            AccountManagerPlugin includes native support for common Apache
            file formats 'htpasswd' and 'htdigest'.  Note that setting
            appropriate directory and file permissions is cruicial for this
            password store, but not covered by this configuration wizard.
          </p>
          <div>
            Details
            <ul>
              <li>
                [_] 'htpasswd' format
                <p class="hint">
                  <strong>HtDigestStore</strong>
                </p>
              </li>
              <ul>
                <li>account-manager:htdigest_file [trac.htdigest_]</li>
                <li>account-manager:htdigest_realm [______________]</li>
              </ul>
              <li>
                [_] 'htdigest' format
                <p class="hint">
                  <strong>HtPasswdStore</strong>
                </p>
              </li>
              <ul>
                <li>account-manager:htpasswd_file [trac.htpasswd_]</li>
                <li>account-manager:htpasswd_hash_type [md5___________]</li>
              </ul>
            </ul>
          </div>

          [_] Use a read-only file-based password store.
          <p class="hint">
            <strong>SvnServePasswordStore</strong> includes support for
            reading svnserve's  password file format.  This is another way to
            enable shared use of authentication data, but relies on independed
            management of the password file.
          </p>
          <div>
            Details
            <ul>
              <li>
                account-manager:password_file [______________]
                <p class="hint">
                  Path to the users file, leave blank to locate the users file
                  by reading svnserve.conf
                </p>
              </li>
            </ul>
          </div>

          [_] Delegate authentication using HTTP authentication.
          <p class="hint">
            AccountManagerPlugin enables use of standard HTTP authentication
            by its <strong>HttpAuthStore</strong> component.  Both Basic and
            Digest authentication callenges are supported.  Apart from being
            read-only this password store does even not support listing users
            for obvious reasons.
          </p>
          <div>
            Details
            <ul>
              <li>
                account-manager:auth_url [______________]
                <p class="hint">
                  URL of the HTTP authentication service
                </p>
              </li>
            </ul>
          </div>

          [_] Use a different password store (requires manual configuration).
          <p class="hint">
            AccountManagerPlugin's modular password store concept encourages
            creation of even more ways to provide user credential beyond the
            natively supported stores.  Setup assistance for these 3rd-party
            authentication providers is not implemented yet.
          </p>

          [_] Chain password stores (requires manual configuration).
          <p class="hint">
            Select the desired password stores and related options to enable
            concurrent use of multiple password stores.  Order matters.
            This is merely a placeholder to skip further configuration details
            in this section if checked, or if a multi-store setup is detected
            in current configuration.
          </p>
          <div>
            Details
            <ul>
              <li>
                account-manager:password_store [______________]
                <p class="hint">
                  Ordered list of password stores, queried in turn
                </p>
              </li>
            </ul>
          </div>
          </fieldset>

          <fieldset py:when="2">
            <legend i18n:msg="step,label">
              Step ${str(active + 1)}: ${steps[active].label}
            </legend>
            <img class="icon" alt="Password refresh icon"
                 src="${href.chrome('/acct_mgr/refresh.png')}" />

          <h3>Objective for Password Policy rules</h3>
          <p>
            While AccountManagerPlugin does not enforce password rules in
            general, there are some other ways to alter password handling.
          </p>

          account-manager:reset_password [_]
          <p class="hint">
            Enable the password reset procedure, that relies on a working
            email sender for Trac, supporting both TracAnnouncer and
            TracNotification
          </p>

          account-manager:generated_password_length [_8]
          <p class="hint">
            Length of the randomly-generated passwords created when resetting
            the password for an account
          </p>

          account-manager:force_passwd_change [_]
          <p class="hint">
            Force the user to change password after a successful reset
          </p>
          </fieldset>

          <fieldset py:when="3">
            <legend i18n:msg="step,label">
              Step ${str(active + 1)}: ${steps[active].label}
            </legend>
            <img class="icon" alt="Account approval icon"
                 src="${href.chrome('/acct_mgr/approval.png')}" />

          <h3>Objective for Account Registration and Verification rules</h3>
          <p>
            You may require administrative approval of new accounts for the
            user registration process.  The ability to immediately ban
            existing accounts is another, related but independed feature.
          </p>

          [_] Allow users to register for a new account.
          <!-- py:if acct_mgr.register.RegistrationModule enabled -->
          account-manager:register_check [BasicCheck, EmailCheck,
            BotTrapCheck, RegExpCheck, UsernamePermCheck]
          <p class="hint">
            Ordered list of checks to use for validating registration requests
          </p>
          <p class="hint">
            All checks provided by AccountManagerPlugin are enabled per
            default, but some are configurable on their own, and checks like
            <strong>BotTrapCheck</strong> don't work at all without additional
            configuration
          </p>

          account-manager:require_approval [_]
          <p class="hint">
            Whether account registration requires administrative approval
            to enable the account or not
          </p>

          account-manager:verify_email [x]
          <p class="hint">
            Enable the email verification procedure, that relies on a working
            email sender for Trac, supporting both TracAnnouncer and
            TracNotification
          </p>
          <!-- /py:if -->
          </fieldset>

          <fieldset py:when="4">
            <legend i18n:msg="step,label">
              Step ${str(active + 1)}: ${steps[active].label}
            </legend>
            <img class="icon" alt="Account guard icon"
                 src="${href.chrome('/acct_mgr/guard.png')}" />

          <h3>Objective for Account Protection rules</h3>
          <p>
            <strong>AccountGuard</strong> component provides additional
            protection.  It is an add-on to AccountManagerPlugin's own
            <strong>LoginModule</strong> discouraging brute-force login
            attempts.
          </p>

          </fieldset>

          <fieldset py:otherwise="">
            <legend i18n:msg="step,label">
              Step ${str(active + 1)}: ${steps[active].label}
            </legend>
            <h3>Review your Configuration</h3>

            <h3>Setup Initialization </h3>
            <p>
              Save the configuration and create one admin and one regular
              user account.
            </p>
          </fieldset>
        </py:choose>

        <div class="buttons">
          <input type="submit" name="next" py:if="active != (len(steps) - 1)"
                 value="${dgettext('acct_mgr', 'Next step')}" />
          <input type="submit" name="save"
                 value="${dgettext('acct_mgr', 'Apply changes')}" />
          <input type="submit" name="next" py:if="active == (len(steps) - 1)"
                 title="${dgettext('acct_mgr', 'Exit wizard')}"
                 value="${dgettext('acct_mgr', 'Cancel')}" />
          <input type="submit" name="save" py:if="active != (len(steps) - 1)"
                 title="${dgettext('acct_mgr', 'Drop any changes')}"
                 value="${dgettext('acct_mgr', 'Refresh')}" />
        </div>
      </form>
    </div>
  </body>
</html>
